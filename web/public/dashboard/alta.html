<!DOCTYPE html>
<html lang="en">

<head>

	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Em alta</title>
	<link rel="shortcut icon" href="../assets/imgs/logo.png" type="image/x-icon">
	<link rel="stylesheet" href="../css/alta.css">
	<link rel="stylesheet" href="../css/header_footer.css">
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script src="../js/sessao.js"></script>
</head>

<body>

	<header>
		<section class="container">
			<a href="../index.html"><img src="../assets/imgs/logo.png" alt="logo"></a>
			<nav class="navbar">
				<ul>
					<li><a href="pesquisar.html">Pesquisar</a></li>
					<li><a href="bemvindo.html">Bem vindo</a></li>
					<li class="log-out" onclick="limparSessao()"><a href="../index.html">Sair</a>
					</li>
				</ul>
			</nav>
		</section>
	</header>

	<main>
		<section class="content">
			<div class="kpis">
				<div class="kpi">
					Seu gênero favorito:
					<span id="b_seugen"> sengen</span>
				</div>
				<div class="kpi">
					Música mais comentada:
					<span id="b_mus_fav"> sengen</span>
				</div>
				<div class="kpi">
					Música melhor avaliada:
					<span id="b_mus_ava"> sengen</span>
				</div>
				<div class="kpi">
					Usuário que mais comenta:
					<span id="b_user"> sengen</span>
				</div>
			</div>
			<div class="graficos" id="graficos">

			</div>
		</section>

	</main>

	<footer>
		<p class="made">
			<img src="../assets/imgs/logo.png" alt="logo">
			Made by Gabriela Cunha
		</p>
		<div class="direita">
			<h3>Contato</h3>
			<p><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
					class="bi bi-geo-alt-fill" viewBox="0 0 16 16">
					<path d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10m0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6" />
				</svg>Rua Doutor tosta, 79</p>
			<p><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
					class="bi bi-envelope-at-fill" viewBox="0 0 16 16">
					<path
						d="M2 2A2 2 0 0 0 .05 3.555L8 8.414l7.95-4.859A2 2 0 0 0 14 2zm-2 9.8V4.698l5.803 3.546zm6.761-2.97-6.57 4.026A2 2 0 0 0 2 14h6.256A4.5 4.5 0 0 1 8 12.5a4.49 4.49 0 0 1 1.606-3.446l-.367-.225L8 9.586zM16 9.671V4.697l-5.803 3.546.338.208A4.5 4.5 0 0 1 12.5 8c1.414 0 2.675.652 3.5 1.671" />
					<path
						d="M15.834 12.244c0 1.168-.577 2.025-1.587 2.025-.503 0-1.002-.228-1.12-.648h-.043c-.118.416-.543.643-1.015.643-.77 0-1.259-.542-1.259-1.434v-.529c0-.844.481-1.4 1.26-1.4.585 0 .87.333.953.63h.03v-.568h.905v2.19c0 .272.18.42.411.42.315 0 .639-.415.639-1.39v-.118c0-1.277-.95-2.326-2.484-2.326h-.04c-1.582 0-2.64 1.067-2.64 2.724v.157c0 1.867 1.237 2.654 2.57 2.654h.045c.507 0 .935-.07 1.18-.18v.731c-.219.1-.643.175-1.237.175h-.044C10.438 16 9 14.82 9 12.646v-.214C9 10.36 10.421 9 12.485 9h.035c2.12 0 3.314 1.43 3.314 3.034zm-4.04.21v.227c0 .586.227.8.581.8.31 0 .564-.17.564-.743v-.367c0-.516-.275-.708-.572-.708-.346 0-.573.245-.573.791" />
				</svg> gabriela.cunha@sptech.school</p>
			<p><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
					class="bi bi-telephone-fill" viewBox="0 0 16 16">
					<path fill-rule="evenodd"
						d="M1.885.511a1.745 1.745 0 0 1 2.61.163L6.29 2.98c.329.423.445.974.315 1.494l-.547 2.19a.68.68 0 0 0 .178.643l2.457 2.457a.68.68 0 0 0 .644.178l2.189-.547a1.75 1.75 0 0 1 1.494.315l2.306 1.794c.829.645.905 1.87.163 2.611l-1.034 1.034c-.74.74-1.846 1.065-2.877.702a18.6 18.6 0 0 1-7.01-4.42 18.6 18.6 0 0 1-4.42-7.009c-.362-1.03-.037-2.137.703-2.877z" />
				</svg> (11) 99993-2081</p>
		</div>
		<div class="links">
			<h2>Links</h2>
			<a href="alta.html">Em alta</a>
			<a href="pesquisar.html">Traduções</a>
			<a href="../login.html">Login</a>
			<a href="../cadastro.html">Cadastro</a>
		</div>
	</footer>

</body>
<script>
	window.onload = exibirGrafico(), exibirKpis();

	b_seugen.innerHTML = sessionStorage.FAVORITO_USUARIO;


	function exibirGrafico() {

		// var musics = JSON.parse(sessionStorage.musics);
		// musics.forEach(item => {
		//     document.getElementById("btnmusic").innerHTML += `
		//     <button class="btn-chart" onclick="exibirmusic(${item.id})" id="btnmusic${item.id}">${item.descricao}</button>
		//     `

		document.getElementById("graficos").innerHTML += `
                <div id="grafico" class="display-none">
                        <canvas id="myChartCanvas"></canvas>
                </div>
				   <div id="grafico" class="display-none">
                        <canvas id="myChartCanvasBarra"></canvas>
                </div>
            `;
		obterDadosGrafico();
		obterDadosGraficoBarra();

		//        \\ });
	}

	function obterDadosGrafico() {

		fetch(`/medidas/pizza`, { cache: 'no-store' }).then(function (response) {
			if (response.ok) {
				response.json().then(function (resposta) {
					// console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
					resposta.reverse();

					plotarGrafico(resposta);

				});
			} else {
				console.error('Nenhum dado encontrado ou erro na API');
			}
		})
			.catch(function (error) {
				console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
			});
	}

	function obterDadosGraficoBarra() {

		fetch(`/medidas/barra`, { cache: 'no-store' }).then(function (response) {
			if (response.ok) {
				response.json().then(function (resposta) {
					console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
					resposta.reverse();

					plotarGraficoBarra(resposta);

				});
			} else {
				console.error('Nenhum dado encontrado ou erro na API');
			}
		})
			.catch(function (error) {
				console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
			});
	}


	function plotarGraficoBarra(resposta) {

		let labels = [];

		let dados = {
			labels: labels,
			datasets: [{
				data: [],
				backgroundColor: [
					'#f76014',
					'#f8bf2d',
					'#8e9797',
				]
			}]
		};

		let opcoes = {
			responsive: true,
			plugins: {
				legend: {
					display: false,
				},	
				title: {
					display: true,
					text: 'Top 3 usuários que mais comentam e as quantidades',
					color: '#fff',
					font: {
						size: 25
					}
				}
			},
			indexAxis: 'y',
			scales: {
				x: {
					ticks: {
						color: '#fff',
						font: {
							size: 20,
						}
					}
				},
				y: {
					ticks: {
						color: '#fff',
						font: {
							size: 20,
						}
					}
				}
			}
		};

		for (i = 0; i < resposta.length; i++) {
			var registro = resposta[i];
			labels.push(registro.nome);
			dados.datasets[0].data.push(registro.contagem);
		}


		const config = {
			type: 'bar',
			data: dados,
			options: opcoes
		};

		let myChart = new Chart(
			document.getElementById(`myChartCanvasBarra`),
			config,
		);

	}



	function plotarGrafico(resposta) {

		// Criando estrutura para plotar gráfico - labels
		let labels = [];

		// Criando estrutura para plotar gráfico - dados
		let dados = {
			labels: labels,
			datasets: [{
				label: 'Quantidade pessoas: ',
				data: [],
				backgroundColor: [
					'#FFF4B7',
					'#006A67',
					'#fff',
					'#f76014',
					'#f8bf2d',
					'#580900',
					'#8e9797',
					'#7c84c3',
					'#444b23',
					'#762f81']
			}]
		};
		let opcoes = {
			responsive: true,
			plugins: {
				legend: {
					display: true,
					position: 'top',
					labels: {
						color: '#fff'
					}
				},
				title: {
					display: true,
					text: 'Gêneros favoritos e suas quantidades',
					color: '#fff',
					font: {
						size: 25
					}
				}
			}
		};

		// console.log('----------------------------------------------')
		// console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
		// console.log(resposta)

		// Inserindo valores recebidos em estrutura para plotar o gráfico
		for (i = 0; i < resposta.length; i++) {
			var registro = resposta[i];
			labels.push(registro.genfav);
			dados.datasets[0].data.push(registro.quantidade);
			// console.log(registro.quantidade)
			// console.log(dados.datasets[0].data)
		}

		// console.log('----------------------------------------------')
		// console.log('O gráfico será plotado com os respectivos valores:')
		// console.log('Labels:')
		// console.log(labels)
		// console.log('Dados:')
		// console.log(dados.datasets)
		// console.log('----------------------------------------------')

		// Criando estrutura para plotar gráfico - config
		const config = {
			type: 'pie',
			data: dados,
			options: opcoes
		};

		// Adicionando gráfico criado em div na tela
		let myChart = new Chart(
			document.getElementById(`myChartCanvas`),
			config,
		);

		// setTimeout(() => atualizarGrafico(dados, myChart), 20000);
	}

	function exibirKpis() {
		console.log('exibir kpis')
		fetch(`/medidas/musmaiscom`, {
			method: "GET"
		})
			.then(res => {
				res.json().then(json => {
					const kpi1 = json[0].nome;
					// console.log(kpi1);
					b_mus_fav.innerHTML = kpi1;
				})
			})
			.catch(err => {
				console.log(err);
			})
		fetch(`/medidas/usumais`, {
			method: "GET"
		})
			.then(res => {
				res.json().then(json => {
					const kpi2 = json[0].nome;
					// console.log(kpi2);
					b_user.innerHTML = kpi2;
				})
			})
			.catch(err => {
				console.log(err);
			})
		fetch(`/medidas/musmelhorava`, {
			method: "GET"
		})
			.then(res => {
				res.json().then(json => {
					const kpi3 = json[0].nome;
					// console.log(kpi3);
					b_mus_ava.innerHTML = kpi3;
				})
			})
			.catch(err => {
				console.log(err);
			})

	}
</script>

</html>